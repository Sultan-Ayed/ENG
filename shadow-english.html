<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadow English â€” ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ù‚</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --card: #1a2235;
    --accent: #00d4aa;
    --accent2: #ff6b6b;
    --accent3: #ffd93d;
    --text: #e8eaf0;
    --muted: #6b7a99;
    --border: #2a3550;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Tajawal', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 600px 400px at 80% 20%, rgba(0,212,170,0.07) 0%, transparent 70%),
      radial-gradient(ellipse 500px 300px at 10% 80%, rgba(255,107,107,0.06) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 3rem;
    animation: fadeDown 0.8s ease;
  }

  .header .badge {
    display: inline-block;
    background: rgba(0,212,170,0.15);
    border: 1px solid rgba(0,212,170,0.4);
    color: var(--accent);
    font-size: 0.75rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 0.4rem 1.2rem;
    border-radius: 100px;
    margin-bottom: 1rem;
    font-family: 'Space Mono', monospace;
  }

  .header h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 0.5rem;
  }

  .header h1 span {
    color: var(--accent);
    position: relative;
  }

  .header h1 span::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), transparent);
  }

  .header p {
    color: var(--muted);
    font-size: 1.1rem;
    margin-top: 0.8rem;
  }

  /* Input Section */
  .input-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    animation: fadeUp 0.8s ease 0.2s both;
  }

  .input-label {
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 0.8rem;
    font-family: 'Space Mono', monospace;
  }

  .url-row {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .url-input {
    flex: 1;
    min-width: 200px;
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.2rem;
    color: var(--text);
    font-size: 1rem;
    font-family: 'Space Mono', monospace;
    direction: ltr;
    transition: border-color 0.2s;
    outline: none;
  }

  .url-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(0,212,170,0.1);
  }

  .url-input::placeholder { color: var(--muted); }

  .load-btn {
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 700;
    font-family: 'Tajawal', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .load-btn:hover {
    background: #00f0c0;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,212,170,0.4);
  }

  .load-btn:active { transform: translateY(0); }

  /* Player Section */
  .player-section {
    display: none;
    animation: fadeUp 0.6s ease;
  }

  .player-section.active { display: block; }

  .player-wrapper {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .video-container {
    position: relative;
    width: 100%;
    padding-top: 56.25%;
    background: #000;
  }

  .video-container iframe,
  .video-container video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Controls Bar */
  .controls-bar {
    padding: 1.2rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    border-top: 1px solid var(--border);
    background: rgba(0,0,0,0.2);
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 0.7rem;
  }

  .control-label {
    font-size: 0.8rem;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
  }

  .speed-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 8px;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    transition: all 0.15s;
  }

  .speed-btn:hover { border-color: var(--accent); color: var(--accent); }
  .speed-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }

  .toggle-switch {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    cursor: pointer;
  }

  .toggle-switch input { display: none; }

  .toggle-track {
    width: 44px;
    height: 24px;
    background: var(--border);
    border-radius: 100px;
    position: relative;
    transition: background 0.2s;
  }

  .toggle-track::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: #fff;
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: transform 0.2s;
  }

  .toggle-switch input:checked + .toggle-track {
    background: var(--accent);
  }

  .toggle-switch input:checked + .toggle-track::after {
    transform: translateX(20px);
  }

  .toggle-label {
    font-size: 0.85rem;
    color: var(--text);
  }

  /* Transcript Section */
  .transcript-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
  }

  .transcript-header {
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(0,0,0,0.2);
  }

  .transcript-title {
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
  }

  .transcript-body {
    padding: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
  }

  .transcript-body::-webkit-scrollbar { width: 6px; }
  .transcript-body::-webkit-scrollbar-track { background: transparent; }
  .transcript-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Transcript Lines */
  .transcript-line {
    display: flex;
    gap: 1rem;
    padding: 0.9rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.3rem;
    border: 1px solid transparent;
    align-items: flex-start;
  }

  .transcript-line:hover {
    background: rgba(0,212,170,0.06);
    border-color: rgba(0,212,170,0.2);
  }

  .transcript-line.active {
    background: rgba(0,212,170,0.12);
    border-color: rgba(0,212,170,0.4);
  }

  .line-time {
    font-size: 0.75rem;
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    white-space: nowrap;
    margin-top: 2px;
    min-width: 45px;
  }

  .line-content {
    flex: 1;
  }

  .line-en {
    font-size: 1rem;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    line-height: 1.5;
    direction: ltr;
    text-align: left;
  }

  .line-ar {
    font-size: 0.9rem;
    color: var(--muted);
    margin-top: 0.3rem;
    direction: rtl;
    text-align: right;
    display: none;
  }

  .show-translation .line-ar { display: block; }

  .repeat-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 8px;
    width: 30px;
    height: 30px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .repeat-btn:hover { border-color: var(--accent3); color: var(--accent3); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--muted);
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .empty-state p {
    font-size: 1rem;
  }

  /* Shadow tip box */
  .tip-box {
    background: linear-gradient(135deg, rgba(0,212,170,0.08), rgba(255,107,107,0.05));
    border: 1px solid rgba(0,212,170,0.2);
    border-radius: 16px;
    padding: 1.2rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    animation: fadeUp 0.8s ease 0.4s both;
  }

  .tip-icon { font-size: 1.5rem; flex-shrink: 0; }

  .tip-text h3 {
    font-size: 1rem;
    color: var(--accent);
    margin-bottom: 0.3rem;
  }

  .tip-text p {
    font-size: 0.88rem;
    color: var(--muted);
    line-height: 1.6;
  }

  /* Looping indicator */
  .loop-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.8rem;
    color: var(--accent3);
    background: rgba(255,217,61,0.1);
    border: 1px solid rgba(255,217,61,0.3);
    padding: 0.2rem 0.7rem;
    border-radius: 100px;
    font-family: 'Space Mono', monospace;
    display: none;
  }

  .loop-indicator.active { display: inline-flex; }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Pulse dot */
  .pulse-dot {
    width: 8px; height: 8px;
    background: var(--accent3);
    border-radius: 50%;
    animation: pulse 1s ease infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.7); }
  }

  /* Demo notice */
  .demo-notice {
    background: rgba(255,217,61,0.08);
    border: 1px solid rgba(255,217,61,0.25);
    border-radius: 12px;
    padding: 0.8rem 1.2rem;
    font-size: 0.85rem;
    color: var(--accent3);
    margin-top: 1rem;
    text-align: center;
    display: none;
    font-family: 'Space Mono', monospace;
    direction: rtl;
  }

  @media (max-width: 600px) {
    .url-row { flex-direction: column; }
    .controls-bar { gap: 1rem; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="badge">ğŸ§ Shadowing Technique</div>
    <h1>ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©<br><span>Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ù‚</span></h1>
    <p>Ø­Ø· Ø±Ø§Ø¨Ø· Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø¨Ø¯Ø£ ØªÙ‚Ù„Ø¯ Ø§Ù„Ù†Ø·Ù‚ Ø³Ø·Ø± Ø¨Ø³Ø·Ø±</p>
  </div>

  <!-- Tip box -->
  <div class="tip-box">
    <div class="tip-icon">ğŸ’¡</div>
    <div class="tip-text">
      <h3>ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ù‚ØŸ</h3>
      <p>Ø§Ø³Ù…Ø¹ ÙƒÙ„ Ø¬Ù…Ù„Ø©ØŒ ÙˆÙ‚Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ ÙˆØ­Ø§ÙˆÙ„ ØªÙƒØ±Ø±Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ø¨Ø±Ø© ÙˆØ§Ù„Ø³Ø±Ø¹Ø©. Ø®Ø°Ù‡Ø§ Ø³Ø·Ø± Ø¨Ø³Ø·Ø±. Ù‚Ù„Ù„ Ø§Ù„Ø³Ø±Ø¹Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©.</p>
    </div>
  </div>

  <!-- URL Input -->
  <div class="input-section">
    <div class="input-label">Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>
    <div class="url-row">
      <input type="text" class="url-input" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." dir="ltr">
      <button class="load-btn" onclick="loadVideo()">ØªØ­Ù…ÙŠÙ„ â–¶</button>
    </div>
    <div class="demo-notice" id="demoNotice">
      âš¡ ÙŠØªØ·Ù„Ø¨ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØªÙØ¹ÙŠÙ„ YouTube IFrame API â€” ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    </div>
  </div>

  <!-- Player Section -->
  <div class="player-section" id="playerSection">

    <div class="player-wrapper">
      <div class="video-container" id="videoContainer"></div>

      <!-- Controls -->
      <div class="controls-bar">
        <div class="control-group">
          <span class="control-label">Ø§Ù„Ø³Ø±Ø¹Ø©:</span>
          <button class="speed-btn" onclick="setSpeed(0.5)">0.5Ã—</button>
          <button class="speed-btn" onclick="setSpeed(0.75)">0.75Ã—</button>
          <button class="speed-btn active" id="speed1" onclick="setSpeed(1)">1Ã—</button>
          <button class="speed-btn" onclick="setSpeed(1.25)">1.25Ã—</button>
          <button class="speed-btn" onclick="setSpeed(1.5)">1.5Ã—</button>
        </div>

        <label class="toggle-switch">
          <input type="checkbox" id="translationToggle" onchange="toggleTranslation()">
          <div class="toggle-track"></div>
          <span class="toggle-label">ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠ</span>
        </label>

        <div class="loop-indicator" id="loopIndicator">
          <div class="pulse-dot"></div>
          ØªÙƒØ±Ø§Ø±
        </div>
      </div>
    </div>

    <!-- Transcript -->
    <div class="transcript-section">
      <div class="transcript-header">
        <span class="transcript-title">Ø§Ù„Ù†Øµ â€” Transcript</span>
        <span style="font-size:0.8rem; color:var(--muted); font-family:'Space Mono',monospace">Ø§Ø¶ØºØ· Ø³Ø·Ø± Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„ÙŠÙ‡</span>
      </div>
      <div class="transcript-body" id="transcriptBody">
        <div class="empty-state">
          <div class="empty-icon">ğŸ¬</div>
          <p>Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Øµ Ù‡Ù†Ø§</p>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
let player = null;
let currentSpeed = 1;
let showTranslation = false;
let loopLineIndex = null;
let loopInterval = null;
let currentVideoType = null; // 'youtube' or 'direct'
let videoElement = null;

// Demo transcript for testing
const demoTranscript = [
  { time: 0,   en: "Welcome to this English learning session.", ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¬Ù„Ø³Ø© ØªØ¹Ù„Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù‡Ø°Ù‡." },
  { time: 4,   en: "Today we're going to practice shadowing.", ar: "Ø§Ù„ÙŠÙˆÙ… Ø³Ù†ØªØ¯Ø±Ø¨ Ø¹Ù„Ù‰ Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ù‚." },
  { time: 8,   en: "Listen carefully to each sentence.", ar: "Ø§Ø³ØªÙ…Ø¹ Ø¨Ø¹Ù†Ø§ÙŠØ© Ù„ÙƒÙ„ Ø¬Ù…Ù„Ø©." },
  { time: 12,  en: "Then try to repeat it out loud.", ar: "Ø«Ù… Ø­Ø§ÙˆÙ„ ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ø¨ØµÙˆØª Ø¹Ø§Ù„Ù." },
  { time: 16,  en: "Don't worry about making mistakes.", ar: "Ù„Ø§ ØªÙ‚Ù„Ù‚ Ø¨Ø´Ø£Ù† Ø§Ø±ØªÙƒØ§Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡." },
  { time: 20,  en: "The more you practice, the better you get.", ar: "ÙƒÙ„Ù…Ø§ ØªØ¯Ø±Ø¨Øª Ø£ÙƒØ«Ø±ØŒ ÙƒÙ„Ù…Ø§ ØªØ­Ø³Ù†Øª." },
  { time: 25,  en: "Try slowing down the video if it's too fast.", ar: "Ø¬Ø±Ø¨ ØªØ¨Ø·ÙŠØ¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø±ÙŠØ¹Ø§Ù‹ Ø¬Ø¯Ø§Ù‹." },
  { time: 30,  en: "Focus on the rhythm and intonation.", ar: "Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¹ ÙˆØ§Ù„ØªÙ†ØºÙŠÙ…." },
  { time: 35,  en: "Shadowing is one of the best ways to improve your accent.", ar: "Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ù‚ Ù‡Ùˆ Ø£Ø­Ø¯ Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ø±Ù‚ Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù‡Ø¬ØªÙƒ." },
  { time: 40,  en: "Keep going, you're doing great!", ar: "Ø§Ø³ØªÙ…Ø±ØŒ Ø£Ù†Øª ØªØ¤Ø¯ÙŠ Ø¨Ø´ÙƒÙ„ Ø±Ø§Ø¦Ø¹!" },
];

function extractYouTubeId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
  ];
  for (const p of patterns) {
    const m = url.match(p);
    if (m) return m[1];
  }
  return null;
}

function loadVideo() {
  const url = document.getElementById('videoUrl').value.trim();
  if (!url) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'); return; }

  const ytId = extractYouTubeId(url);

  document.getElementById('playerSection').classList.add('active');

  if (ytId) {
    currentVideoType = 'youtube';
    loadYouTube(ytId);
  } else if (url.match(/\.(mp4|webm|ogg)$/i) || url.startsWith('blob:')) {
    currentVideoType = 'direct';
    loadDirectVideo(url);
  } else {
    // Try as iframe (for other embeds)
    currentVideoType = 'iframe';
    loadIframe(url);
  }

  renderTranscript(demoTranscript);
}

function loadYouTube(videoId) {
  const container = document.getElementById('videoContainer');
  container.innerHTML = '';

  if (window.YT && window.YT.Player) {
    createYTPlayer(videoId);
  } else {
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = () => createYTPlayer(videoId);
  }
}

function createYTPlayer(videoId) {
  const div = document.createElement('div');
  div.id = 'ytPlayer';
  document.getElementById('videoContainer').appendChild(div);

  player = new YT.Player('ytPlayer', {
    videoId: videoId,
    playerVars: { autoplay: 0, rel: 0, modestbranding: 1 },
    events: {
      onReady: () => {
        document.getElementById('demoNotice').style.display = 'none';
        startTimeTracker();
      }
    }
  });
}

function loadDirectVideo(url) {
  const container = document.getElementById('videoContainer');
  container.innerHTML = `<video controls src="${url}" style="position:absolute;inset:0;width:100%;height:100%;"></video>`;
  videoElement = container.querySelector('video');
  videoElement.playbackRate = currentSpeed;
  startTimeTracker();
}

function loadIframe(url) {
  const container = document.getElementById('videoContainer');
  container.innerHTML = `<iframe src="${url}" allowfullscreen allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>`;
  document.getElementById('demoNotice').style.display = 'block';
  renderTranscript(demoTranscript);
}

function setSpeed(speed) {
  currentSpeed = speed;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');

  if (player && player.setPlaybackRate) {
    player.setPlaybackRate(speed);
  }
  if (videoElement) {
    videoElement.playbackRate = speed;
  }
}

function toggleTranslation() {
  showTranslation = document.getElementById('translationToggle').checked;
  const body = document.getElementById('transcriptBody');
  if (showTranslation) {
    body.classList.add('show-translation');
  } else {
    body.classList.remove('show-translation');
  }
}

function renderTranscript(lines) {
  const body = document.getElementById('transcriptBody');
  body.innerHTML = '';

  lines.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = 'transcript-line';
    div.id = `line-${i}`;
    div.innerHTML = `
      <span class="line-time">${formatTime(line.time)}</span>
      <div class="line-content">
        <div class="line-en">${line.en}</div>
        <div class="line-ar">${line.ar}</div>
      </div>
      <button class="repeat-btn" title="ÙƒØ±Ø± Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±" onclick="toggleLoop(${i}, ${line.time}, event)">ğŸ”</button>
    `;
    div.addEventListener('click', (e) => {
      if (e.target.classList.contains('repeat-btn')) return;
      seekTo(line.time);
    });
    body.appendChild(div);
  });
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m}:${sec.toString().padStart(2,'0')}`;
}

function seekTo(seconds) {
  if (player && player.seekTo) {
    player.seekTo(seconds, true);
    player.playVideo && player.playVideo();
  }
  if (videoElement) {
    videoElement.currentTime = seconds;
    videoElement.play();
  }
}

function toggleLoop(index, time, e) {
  e.stopPropagation();
  const indicator = document.getElementById('loopIndicator');
  const lines = demoTranscript;

  if (loopLineIndex === index) {
    loopLineIndex = null;
    clearInterval(loopInterval);
    indicator.classList.remove('active');
    document.querySelectorAll('.repeat-btn').forEach(b => b.style.color = '');
    return;
  }

  loopLineIndex = index;
  indicator.classList.add('active');
  document.querySelectorAll('.repeat-btn').forEach(b => b.style.color = '');
  e.target.style.color = 'var(--accent3)';

  seekTo(time);
  clearInterval(loopInterval);

  const nextTime = lines[index + 1] ? lines[index + 1].time : time + 6;
  const duration = (nextTime - time) / currentSpeed * 1000;

  loopInterval = setInterval(() => {
    seekTo(time);
  }, duration + 500);
}

function startTimeTracker() {
  setInterval(() => {
    let currentTime = 0;

    if (player && player.getCurrentTime) {
      try { currentTime = player.getCurrentTime(); } catch(e) {}
    }
    if (videoElement) {
      currentTime = videoElement.currentTime;
    }

    highlightCurrentLine(currentTime);
  }, 300);
}

function highlightCurrentLine(currentTime) {
  const lines = demoTranscript;
  let activeIndex = 0;

  for (let i = 0; i < lines.length; i++) {
    if (currentTime >= lines[i].time) activeIndex = i;
  }

  document.querySelectorAll('.transcript-line').forEach((el, i) => {
    el.classList.toggle('active', i === activeIndex);
  });

  // Auto-scroll
  const activeLine = document.getElementById(`line-${activeIndex}`);
  if (activeLine) {
    activeLine.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}
</script>
</body>
</html>
