<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadow English â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --card: #1a2235;
    --accent: #00d4aa;
    --accent3: #ffd93d;
    --text: #e8eaf0;
    --muted: #6b7a99;
    --border: #2a3550;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Tajawal', sans-serif;
    min-height: 100vh;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .header { text-align: center; margin-bottom: 2rem; }
  .header h1 span { color: var(--accent); }

  .input-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .url-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
  
  .url-input {
    flex: 1;
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 0.8rem;
    color: var(--text);
    direction: ltr;
    outline: none;
  }

  textarea.url-input { width: 100%; height: 100px; font-family: 'Space Mono', monospace; font-size: 0.8rem; }

  .load-btn {
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 12px;
    padding: 0 1.5rem;
    font-weight: 700;
    cursor: pointer;
  }

  .player-section { display: none; }
  .player-section.active { display: block; }

  .player-wrapper {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .video-container { position: relative; width: 100%; padding-top: 56.25%; background: #000; }
  .video-container iframe, .video-container video { position: absolute; inset: 0; width: 100%; height: 100%; }

  .controls-bar {
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    background: rgba(0,0,0,0.2);
    border-top: 1px solid var(--border);
  }

  .speed-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.3rem 0.6rem;
    border-radius: 5px;
    cursor: pointer;
  }

  .speed-btn.active { background: var(--accent); color: #000; }

  .transcript-body {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 1rem;
    max-height: 400px;
    overflow-y: auto;
  }

  .transcript-line {
    display: flex; gap: 1rem; padding: 0.8rem; border-radius: 10px;
    cursor: pointer; margin-bottom: 0.5rem; border: 1px solid transparent;
  }

  .transcript-line.active { background: rgba(0,212,170,0.15); border-color: var(--accent); }

  .line-time { color: var(--accent); font-family: 'Space Mono'; min-width: 50px; }
  .line-en { direction: ltr; text-align: left; flex: 1; }

  .repeat-btn { background: none; border: 1px solid var(--border); color: var(--muted); cursor: pointer; border-radius: 5px; }

  .loop-indicator { display: none; color: var(--accent3); font-size: 0.8rem; }
  .loop-indicator.active { display: inline-block; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Shadow <span>English</span></h1>
    <p>ØªØ¹Ù„Ù… Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù†Øµ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p>
  </div>

  <div class="input-section">
    <div class="url-row">
      <input type="text" class="url-input" id="videoUrl" placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨..." dir="ltr">
      <button class="load-btn" onclick="loadVideo()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
    </div>
    <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 0.5rem;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</p>
    <textarea id="customTranscript" class="url-input" placeholder='[{"time": 0, "en": "Hello world"}, {"time": 5, "en": "Welcome home"}]'></textarea>
  </div>

  <div class="player-section" id="playerSection">
    <div class="player-wrapper">
      <div class="video-container" id="videoContainer"></div>
      <div class="controls-bar">
        <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
        <button class="speed-btn active" id="speed1" onclick="setSpeed(1)">1x</button>
        <button class="speed-btn" onclick="setSpeed(1.5)">1.5x</button>
        <span class="loop-indicator" id="loopIndicator">ğŸ”„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…ÙØ¹Ù„</span>
      </div>
    </div>

    <div class="transcript-body" id="transcriptBody"></div>
  </div>
</div>

<script>
let player = null;
let currentSpeed = 1;
let loopLineIndex = null;
let currentVideoType = null;
let videoElement = null;
let activeTranscript = [];

const demoTranscript = [
  { time: 0, en: "Welcome! Please add your own transcript above." },
  { time: 4, en: "This is a demo sentence to show synchronization." }
];

function extractYouTubeId(url) {
  const p = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/;
  const m = url.match(p);
  return m ? m[1] : null;
}

function loadVideo() {
  const url = document.getElementById('videoUrl').value.trim();
  const customText = document.getElementById('customTranscript').value.trim();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ: Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
  activeTranscript = customText ? JSON.parse(customText) : demoTranscript;

  const ytId = extractYouTubeId(url);
  document.getElementById('playerSection').classList.add('active');

  if (ytId) {
    currentVideoType = 'youtube';
    loadYouTube(ytId);
  } else if (url.match(/\.(mp4|webm)$/i)) {
    currentVideoType = 'direct';
    loadDirectVideo(url);
  }
  renderTranscript();
}

function loadYouTube(videoId) {
  const container = document.getElementById('videoContainer');
  container.innerHTML = '<div id="ytPlayer"></div>';
  if (window.YT) {
    createYTPlayer(videoId);
  } else {
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = () => createYTPlayer(videoId);
  }
}

function createYTPlayer(videoId) {
  player = new YT.Player('ytPlayer', {
    videoId: videoId,
    events: { 'onReady': () => startTimeTracker() }
  });
}

function loadDirectVideo(url) {
  const container = document.getElementById('videoContainer');
  container.innerHTML = `<video id="mainVideo" controls autoplay src="${url}" style="width:100%;height:100%;"></video>`;
  videoElement = document.getElementById('mainVideo');
  startTimeTracker();
}

function renderTranscript() {
  const body = document.getElementById('transcriptBody');
  body.innerHTML = '';
  activeTranscript.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = 'transcript-line';
    div.id = `line-${i}`;
    div.innerHTML = `
      <span class="line-time">${line.time}s</span>
      <div class="line-en">${line.en}</div>
      <button class="repeat-btn" onclick="toggleLoop(${i}, event)">ğŸ”</button>
    `;
    div.onclick = (e) => { if(!e.target.classList.contains('repeat-btn')) seekTo(line.time); };
    body.appendChild(div);
  });
}

function seekTo(seconds) {
  if (currentVideoType === 'youtube' && player.seekTo) player.seekTo(seconds, true);
  else if (videoElement) videoElement.currentTime = seconds;
}

function toggleLoop(index, e) {
  e.stopPropagation();
  loopLineIndex = (loopLineIndex === index) ? null : index;
  document.getElementById('loopIndicator').classList.toggle('active', loopLineIndex !== null);
  if (loopLineIndex !== null) seekTo(activeTranscript[index].time);
}

function startTimeTracker() {
  setInterval(() => {
    let curr = 0;
    if (currentVideoType === 'youtube' && player.getCurrentTime) curr = player.getCurrentTime();
    else if (videoElement) curr = videoElement.currentTime;

    if (loopLineIndex !== null) {
      const start = activeTranscript[loopLineIndex].time;
      const end = activeTranscript[loopLineIndex+1] ? activeTranscript[loopLineIndex+1].time : start + 5;
      if (curr >= end || curr < start - 0.5) seekTo(start);
    }

    highlightLine(curr);
  }, 100);
}

function highlightLine(curr) {
  let activeIdx = -1;
  activeTranscript.forEach((line, i) => {
    if (curr >= line.time) activeIdx = i;
  });

  document.querySelectorAll('.transcript-line').forEach((el, i) => {
    el.classList.toggle('active', i === activeIdx);
    if (i === activeIdx && !isElementInViewport(el)) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });
}

function isElementInViewport(el) {
  const rect = el.getBoundingClientRect();
  return (rect.top >= 0 && rect.bottom <= window.innerHeight);
}

function setSpeed(speed) {
  if (player && player.setPlaybackRate) player.setPlaybackRate(speed);
  if (videoElement) videoElement.playbackRate = speed;
  document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}
</script>
</body>
</html>
