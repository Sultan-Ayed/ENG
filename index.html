<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadow English â€” ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a; --card: #1a2235; --accent: #00d4aa;
    --gold: #ffd93d; --text: #e8eaf0; --muted: #6b7a99; --border: #2a3550;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Tajawal',sans-serif; min-height:100vh; overflow-x:hidden; }
  body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse 600px 400px at 80% 20%,rgba(0,212,170,.07) 0%,transparent 70%),radial-gradient(ellipse 500px 300px at 10% 80%,rgba(255,107,107,.05) 0%,transparent 70%); pointer-events:none; z-index:0; }

  .wrap { max-width:960px; margin:0 auto; padding:2rem 1.5rem; position:relative; z-index:1; }

  /* Header */
  .header { text-align:center; margin-bottom:2.5rem; animation:fadeDown .7s ease; }
  .badge { display:inline-block; background:rgba(0,212,170,.12); border:1px solid rgba(0,212,170,.35); color:var(--accent); font-size:.72rem; letter-spacing:3px; text-transform:uppercase; padding:.35rem 1.1rem; border-radius:100px; margin-bottom:.9rem; font-family:'Space Mono',monospace; }
  .header h1 { font-size:clamp(2rem,5vw,3rem); font-weight:900; line-height:1.1; }
  .header h1 span { color:var(--accent); }
  .header p { color:var(--muted); font-size:1rem; margin-top:.5rem; }
  .dedication { display:inline-flex; align-items:center; gap:.6rem; margin-top:1.2rem; background:rgba(0,212,170,.06); border:1px solid rgba(0,212,170,.2); border-radius:100px; padding:.5rem 1.2rem; flex-wrap:wrap; justify-content:center; }
  .ded-label { font-size:.82rem; color:var(--muted); }
  .ded-name  { font-size:.95rem; font-weight:700; }
  .ded-link  { font-size:.82rem; color:var(--accent); text-decoration:none; border:1px solid rgba(0,212,170,.35); border-radius:100px; padding:.2rem .8rem; font-family:'Space Mono',monospace; transition:all .2s; }
  .ded-link:hover { background:rgba(0,212,170,.12); }

  /* Steps */
  .steps { display:flex; gap:1rem; margin-bottom:2rem; animation:fadeUp .6s ease .1s both; }
  .step { flex:1; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:1.1rem; text-align:center; }
  .step-num { width:30px; height:30px; background:rgba(0,212,170,.12); border:1px solid var(--accent); color:var(--accent); border-radius:50%; font-size:.82rem; font-weight:700; display:flex; align-items:center; justify-content:center; margin:0 auto .6rem; font-family:'Space Mono',monospace; }
  .step-title { font-size:.88rem; font-weight:700; margin-bottom:.25rem; }
  .step-desc  { font-size:.76rem; color:var(--muted); line-height:1.5; }

  /* Card */
  .card { background:var(--card); border:1px solid var(--border); border-radius:20px; margin-bottom:1.5rem; overflow:hidden; animation:fadeUp .6s ease .2s both; }
  .card-head { padding:.9rem 1.4rem; border-bottom:1px solid var(--border); background:rgba(0,0,0,.18); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:.8rem; }
  .card-title { font-size:.8rem; color:var(--muted); letter-spacing:2px; text-transform:uppercase; font-family:'Space Mono',monospace; }
  .card-body  { padding:1.3rem; }

  /* Buttons */
  .btn      { background:var(--accent); color:#000; border:none; border-radius:12px; padding:.85rem 1.7rem; font-size:.93rem; font-weight:700; font-family:'Tajawal',sans-serif; cursor:pointer; transition:all .18s; white-space:nowrap; }
  .btn:hover { background:#00f0c0; transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,212,170,.35); }
  .btn-sm   { background:var(--accent); color:#000; border:none; border-radius:9px; padding:.4rem 1rem; font-size:.82rem; font-weight:700; font-family:'Tajawal',sans-serif; cursor:pointer; white-space:nowrap; transition:all .18s; }
  .btn-outline { background:transparent; color:var(--accent); border:1px solid var(--accent); border-radius:12px; padding:.85rem 1.7rem; font-size:.93rem; font-weight:700; font-family:'Tajawal',sans-serif; cursor:pointer; transition:all .18s; }
  .btn-outline:hover { background:rgba(0,212,170,.08); }
  .btn-ghost { background:transparent; color:var(--muted); border:1px solid var(--border); border-radius:9px; padding:.4rem 1rem; font-size:.82rem; font-family:'Tajawal',sans-serif; cursor:pointer; }

  /* Inputs */
  .url-row { display:flex; gap:.8rem; flex-wrap:wrap; }
  .url-input, .tr-input {
    background:var(--bg); border:2px solid var(--border); border-radius:12px;
    padding:.85rem 1.1rem; color:var(--text); outline:none; transition:border-color .2s;
    font-family:'Space Mono',monospace; direction:ltr;
  }
  .url-input { flex:1; min-width:200px; font-size:.92rem; }
  .tr-input  { width:100%; font-size:.86rem; resize:vertical; min-height:160px; line-height:1.7; }
  .url-input:focus,.tr-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,212,170,.1); }
  .url-input::placeholder,.tr-input::placeholder { color:var(--muted); font-size:.8rem; }

  /* Pills */
  .pill-ok   { background:rgba(0,212,170,.1); color:var(--accent); border:1px solid rgba(0,212,170,.3); border-radius:100px; padding:.22rem .8rem; font-size:.72rem; font-family:'Space Mono',monospace; }
  .pill-warn { background:rgba(255,217,61,.1); color:var(--gold); border:1px solid rgba(255,217,61,.3); border-radius:100px; padding:.22rem .8rem; font-size:.72rem; font-family:'Space Mono',monospace; }

  /* How-to box */
  .how-to { background:rgba(0,212,170,.04); border:1px solid rgba(0,212,170,.14); border-radius:12px; padding:1rem 1.2rem; margin-top:1rem; font-size:.82rem; color:var(--muted); line-height:1.9; }
  .how-to strong { color:var(--accent); }
  .row-actions { display:flex; gap:.8rem; margin-top:1rem; justify-content:flex-end; flex-wrap:wrap; }

  /* Player */
  .video-wrap { position:relative; width:100%; padding-top:56.25%; background:#000; }
  .video-wrap iframe { position:absolute; inset:0; width:100%; height:100%; border:none; }
  .controls-bar { padding:.9rem 1.4rem; display:flex; align-items:center; gap:1.3rem; flex-wrap:wrap; border-top:1px solid var(--border); background:rgba(0,0,0,.18); }
  .ctrl-group { display:flex; align-items:center; gap:.45rem; }
  .ctrl-label { font-size:.75rem; color:var(--muted); font-family:'Space Mono',monospace; }

  .speed-btn { background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:8px; padding:.3rem .65rem; font-size:.78rem; cursor:pointer; font-family:'Space Mono',monospace; transition:all .14s; }
  .speed-btn:hover  { border-color:var(--accent); color:var(--accent); }
  .speed-btn.active { background:var(--accent); color:#000; border-color:var(--accent); font-weight:700; }

  /* Toggle */
  .toggle-sw { display:flex; align-items:center; gap:.55rem; cursor:pointer; }
  .toggle-sw input { display:none; }
  .toggle-track { width:38px; height:21px; background:var(--border); border-radius:100px; position:relative; transition:background .2s; flex-shrink:0; }
  .toggle-track::after { content:''; position:absolute; width:15px; height:15px; background:#fff; border-radius:50%; top:3px; left:3px; transition:transform .2s; }
  .toggle-sw input:checked + .toggle-track { background:var(--accent); }
  .toggle-sw input:checked + .toggle-track::after { transform:translateX(17px); }
  .toggle-label { font-size:.83rem; }

  /* Loop badge */
  .loop-badge { display:none; align-items:center; gap:.35rem; font-size:.75rem; color:var(--gold); background:rgba(255,217,61,.08); border:1px solid rgba(255,217,61,.3); padding:.22rem .65rem; border-radius:100px; font-family:'Space Mono',monospace; }
  .loop-badge.on { display:inline-flex; }
  .pulse { width:6px; height:6px; background:var(--gold); border-radius:50%; animation:pulse 1s ease infinite; }

  /* Transcript lines */
  .tr-body { padding:.9rem; max-height:440px; overflow-y:auto; }
  .tr-body::-webkit-scrollbar { width:5px; }
  .tr-body::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  .t-line { display:flex; gap:.7rem; padding:.75rem .85rem; border-radius:11px; cursor:pointer; transition:all .13s; margin-bottom:.18rem; border:1px solid transparent; align-items:flex-start; }
  .t-line:hover  { background:rgba(0,212,170,.05); border-color:rgba(0,212,170,.2); }
  .t-line.active { background:rgba(0,212,170,.11); border-color:rgba(0,212,170,.42); }

  .t-time { font-size:.7rem; color:var(--accent); font-family:'Space Mono',monospace; white-space:nowrap; margin-top:3px; min-width:40px; }
  .t-en   { font-size:.94rem; color:var(--text); font-family:'Space Mono',monospace; line-height:1.55; direction:ltr; text-align:left; }
  .t-ar   { font-size:.88rem; color:var(--muted); margin-top:.28rem; direction:rtl; text-align:right; font-family:'Tajawal',sans-serif; display:none; }
  .show-ar .t-ar { display:block; }
  .t-ar:empty { display:none !important; }

  .rep-btn { background:none; border:1px solid var(--border); color:var(--muted); border-radius:7px; width:27px; height:27px; font-size:.82rem; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .13s; }
  .rep-btn:hover { border-color:var(--gold); color:var(--gold); }
  .rep-btn.on { border-color:var(--gold); color:var(--gold); background:rgba(255,217,61,.1); }

  .star-btn { background:none; border:1px solid var(--border); color:var(--muted); border-radius:7px; width:27px; height:27px; font-size:.82rem; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .13s; }
  .star-btn:hover { border-color:#f9ca24; color:#f9ca24; }
  .star-btn.on { border-color:#f9ca24; color:#f9ca24; background:rgba(249,202,36,.15); }

  /* Favorites tab */
  .tabs { display:flex; gap:0; border-bottom:1px solid var(--border); }
  .tab-btn { flex:1; padding:.7rem 1rem; background:none; border:none; color:var(--muted); font-size:.82rem; font-family:'Tajawal',sans-serif; cursor:pointer; transition:all .15s; border-bottom:2px solid transparent; }
  .tab-btn.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:700; }
  .tab-btn:hover { color:var(--text); }
  .tab-pane { display:none; }
  .tab-pane.active { display:block; }
  .fav-empty { text-align:center; padding:2.5rem; color:var(--muted); font-size:.9rem; }
  .fav-empty .fav-icon { font-size:2rem; margin-bottom:.6rem; }

  /* Error box */
  .err-box { margin:.8rem 1.4rem; background:rgba(225,112,85,.1); border:1px solid rgba(225,112,85,.3); border-radius:10px; padding:.7rem 1rem; font-size:.8rem; color:#e17055; font-family:'Space Mono',monospace; direction:ltr; word-break:break-all; }

  /* Hidden */
  .hidden { display:none; }

  @keyframes fadeDown { from{opacity:0;transform:translateY(-18px)} to{opacity:1;transform:translateY(0)} }
  @keyframes fadeUp   { from{opacity:0;transform:translateY(18px)}  to{opacity:1;transform:translateY(0)} }
  @keyframes pulse    { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.6)} }
  @keyframes modalIn  { from{opacity:0;transform:scale(.95)} to{opacity:1;transform:scale(1)} }

  /* â”€â”€ Help Modal â”€â”€ */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:1000; display:flex; align-items:center; justify-content:center; padding:1rem; backdrop-filter:blur(4px); }
  .modal-overlay.hidden { display:none; }
  .modal-box { background:#111827; border:1px solid var(--border); border-radius:24px; width:100%; max-width:680px; max-height:90vh; overflow-y:auto; animation:modalIn .25s ease; }
  .modal-box::-webkit-scrollbar { width:5px; }
  .modal-box::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  .modal-head { padding:1.3rem 1.5rem; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; background:#111827; z-index:1; }
  .modal-title { font-size:1.1rem; font-weight:700; }
  .modal-close { background:none; border:1px solid var(--border); color:var(--muted); border-radius:8px; width:32px; height:32px; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; }
  .modal-close:hover { border-color:var(--accent2,#ff6b6b); color:var(--accent2,#ff6b6b); }
  .modal-body { padding:1.5rem; }

  /* Steps inside modal */
  .guide-step { display:flex; gap:1.2rem; margin-bottom:1.8rem; align-items:flex-start; }
  .guide-num { width:36px; height:36px; background:rgba(0,212,170,.15); border:2px solid var(--accent); color:var(--accent); border-radius:50%; font-size:1rem; font-weight:900; display:flex; align-items:center; justify-content:center; flex-shrink:0; font-family:'Space Mono',monospace; }
  .guide-content h3 { font-size:1rem; font-weight:700; margin-bottom:.4rem; }
  .guide-content p  { font-size:.88rem; color:var(--muted); line-height:1.7; }
  .guide-content .tip { background:rgba(0,212,170,.06); border:1px solid rgba(0,212,170,.2); border-radius:10px; padding:.6rem .9rem; margin-top:.6rem; font-size:.82rem; color:var(--accent); }
  .guide-img { width:100%; border-radius:12px; border:1px solid var(--border); margin-top:.8rem; background:var(--card); overflow:hidden; }
  .guide-img-inner { padding:1rem; font-family:'Space Mono',monospace; font-size:.78rem; direction:ltr; }
  /* Simulated UI screenshot */
  .sim-bar { display:flex; gap:.5rem; padding:.5rem .7rem; background:rgba(0,0,0,.3); border-radius:8px; align-items:center; margin-bottom:.5rem; }
  .sim-input { flex:1; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:6px; padding:.35rem .7rem; color:var(--muted); font-size:.75rem; font-family:'Space Mono',monospace; direction:ltr; }
  .sim-btn { background:var(--accent); color:#000; border:none; border-radius:6px; padding:.35rem .8rem; font-size:.75rem; font-weight:700; font-family:'Tajawal',sans-serif; }
  .sim-line { display:flex; gap:.6rem; padding:.4rem .6rem; border-radius:7px; align-items:center; font-size:.75rem; }
  .sim-line.hl { background:rgba(0,212,170,.12); border:1px solid rgba(0,212,170,.3); }
  .sim-time { color:var(--accent); min-width:35px; font-family:'Space Mono',monospace; }
  .sim-text { color:var(--text); font-family:'Space Mono',monospace; }
  .sim-ar   { color:var(--muted); font-family:'Tajawal',sans-serif; font-size:.8rem; }
  .sim-icons { display:flex; gap:.3rem; margin-right:auto; }
  .sim-icon { width:20px; height:20px; border:1px solid var(--border); border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:.65rem; }
  .sim-icon.gold { border-color:#f9ca24; color:#f9ca24; }

  @media(max-width:640px) { .steps{flex-direction:column} .url-row{flex-direction:column} .controls-bar{gap:.8rem} .guide-step{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="header">
    <div class="badge">ğŸ§ Shadowing Method</div>
    <h1>ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©<br><span>Ø¨Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬</span></h1>
    <p>Ù‚Ù„Ù‘Ø¯ Ø§Ù„Ù†Ø·Ù‚ Ø³Ø·Ø± Ø¨Ø³Ø·Ø± â€” Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø³Ø±Ø¹ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù„ØºØ©</p>
    <button onclick="openHelp()" style="margin-top:1rem;background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.35);color:#00d4aa;border-radius:100px;padding:.45rem 1.3rem;font-size:.85rem;font-family:'Tajawal',sans-serif;cursor:pointer;">
      â“ ÙƒÙŠÙ Ø£Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ
    </button>
    <div class="dedication">
      <span class="ded-label">Ø¥Ù‡Ø¯Ø§Ø¡ Ù…Ù†</span>
      <strong class="ded-name">Ù….Ø³Ù„Ø·Ø§Ù† Ø¨Ù† Ø¹Ø§ÙŠØ¯</strong>
      <a href="https://sultan-ayed.github.io/my/" target="_blank" class="ded-link">ğŸŒ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
    </div>
  </div>

  <!-- Steps -->
  <div class="steps">
    <div class="step"><div class="step-num">Ù¡</div><div class="step-title">Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div><div class="step-desc">Ø£ÙŠ Ù…Ù‚Ø·Ø¹ ÙŠÙˆØªÙŠÙˆØ¨</div></div>
    <div class="step"><div class="step-num">Ù¢</div><div class="step-title">Ø§Ù†Ø³Ø® Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</div><div class="step-desc">â‹¯ â† Show transcript â† Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</div></div>
    <div class="step"><div class="step-num">Ù£</div><div class="step-title">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬!</div><div class="step-desc">Ø§Ø³Ù…Ø¹ â† ÙˆÙ‚Ù‘Ù â† Ù‚Ù„Ù‘Ø¯ â† ÙƒØ±Ø± ğŸ¯</div></div>
  </div>

  <!-- SETUP SECTION -->
  <div id="setupSection">

    <!-- URL -->
    <div class="card">
      <div class="card-head">
        <span class="card-title">ğŸ“º Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
        <span class="hidden" id="urlPill"></span>
      </div>
      <div class="card-body">
        <div class="url-row">
          <input type="text" class="url-input" id="videoUrl" placeholder="https://www.youtube.com/watch?v=..." oninput="checkUrl()">
          <button class="btn" onclick="startSession()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© â–¶</button>
        </div>
      </div>
    </div>

    <!-- Transcript -->
    <div class="card">
      <div class="card-head">
        <span class="card-title">ğŸ“ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</span>
        <span class="hidden" id="trPill"></span>
      </div>
      <div class="card-body">
        <textarea class="tr-input" id="trInput" oninput="checkTr()"
          placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù…Ù†Ø³ÙˆØ® Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨...&#10;&#10;Ù…Ø«Ø§Ù„:&#10;0:00&#10;Hello and welcome back everyone.&#10;0:04&#10;Today we will practice English."></textarea>
        <div class="how-to">
          <strong>ğŸ“‹ ÙƒÙŠÙ ØªÙ†Ø³Ø® Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨ØªØŸ</strong><br>
          Ù¡. Ø§ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­<br>
          Ù¢. ØªØ­Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ø¶ØºØ· <strong>â‹¯ (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·)</strong><br>
          Ù£. Ø§Ø®ØªØ± <strong>"Show transcript"</strong><br>
          Ù¤. Ø­Ø¯Ø¯ Ø§Ù„ÙƒÙ„ ÙˆØ§Ù†Ø³Ø®Ù‡ <strong>(Ctrl+A Ø«Ù… Ctrl+C)</strong> ÙˆØ§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§
        </div>
        <div class="row-actions">
          <button class="btn-outline" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          <button class="btn" onclick="startSession()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PLAYER SECTION -->
  <div id="playerSection" class="hidden">

    <!-- Video card -->
    <div class="card">
      <div class="card-head">
        <span class="card-title">ğŸ¬ Ø§Ù„Ù…Ø´ØºÙ„</span>
        <div style="display:flex;align-items:center;gap:.8rem;flex-wrap:wrap">
          <div class="loop-badge" id="loopBadge"><div class="pulse"></div> ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø·Ø±</div>
          <button class="btn-ghost" onclick="backToSetup()">â† ØªØºÙŠÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
        </div>
      </div>
      <div class="video-wrap"><div id="ytContainer"></div></div>
      <div class="controls-bar">
        <div class="ctrl-group">
          <span class="ctrl-label">Ø§Ù„Ø³Ø±Ø¹Ø©:</span>
          <button class="speed-btn" onclick="setSpeed(0.5,this)">0.5Ã—</button>
          <button class="speed-btn" onclick="setSpeed(0.75,this)">0.75Ã—</button>
          <button class="speed-btn active" onclick="setSpeed(1,this)">1Ã—</button>
          <button class="speed-btn" onclick="setSpeed(1.25,this)">1.25Ã—</button>
          <button class="speed-btn" onclick="setSpeed(1.5,this)">1.5Ã—</button>
        </div>
        <label class="toggle-sw">
          <input type="checkbox" id="arToggle" onchange="toggleAr()">
          <div class="toggle-track"></div>
          <span class="toggle-label">ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠ</span>
        </label>
      </div>
    </div>

    <!-- Transcript viewer -->
    <div class="card">
      <div class="card-head">
        <span class="card-title">ğŸ“„ Ø§Ù„Ù†Øµ</span>
        <div style="display:flex;align-items:center;gap:.8rem;flex-wrap:wrap">
          <span style="font-size:.72rem;color:var(--muted);font-family:'Space Mono',monospace">â­ Ù„Ù„Ù…ÙØ¶Ù„Ø© | ğŸ” Ù„Ù„ØªÙƒØ±Ø§Ø±</span>
          <button class="btn-sm" id="trBtn" onclick="translateAll()">ğŸŒ ØªØ±Ø¬Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</button>
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('all',this)">ğŸ“„ ÙƒÙ„ Ø§Ù„Ø³Ø·ÙˆØ±</button>
        <button class="tab-btn" onclick="switchTab('fav',this)">â­ Ø§Ù„Ù…ÙØ¶Ù„Ø© <span id="favCount" style="background:rgba(249,202,36,.2);color:#f9ca24;border-radius:100px;padding:0 .5rem;font-size:.72rem;margin-right:.3rem;display:none">0</span></button>
      </div>
      <div id="errBox" class="err-box hidden"></div>
      <div class="tab-pane active" id="paneAll">
        <div class="tr-body" id="trBody"></div>
      </div>
      <div class="tab-pane" id="paneFav">
        <div class="tr-body" id="favBody">
          <div class="fav-empty"><div class="fav-icon">â­</div><p>Ø§Ø¶ØºØ· â­ Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠ Ø³Ø·Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ÙØ¶Ù„Ø©</p></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â”€â”€ Help Modal â”€â”€ -->
<div class="modal-overlay hidden" id="helpModal" onclick="closeHelpOutside(event)">
  <div class="modal-box">
    <div class="modal-head">
      <span class="modal-title">ğŸ“– ÙƒÙŠÙ ØªØ³ØªØ®Ø¯Ù… Shadow EnglishØŸ</span>
      <button class="modal-close" onclick="closeHelp()">âœ•</button>
    </div>
    <div class="modal-body">

      <!-- Step 1 -->
      <div class="guide-step">
        <div class="guide-num">Ù¡</div>
        <div class="guide-content">
          <h3>Ø§ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØ§Ù†Ø³Ø® Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</h3>
          <p>Ø§ÙØªØ­ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¹Ù„Ù‰ ÙŠÙˆØªÙŠÙˆØ¨ ÙÙŠ Ù…ØªØµÙØ­ÙƒØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong style="color:var(--accent)">â‹¯ (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·)</strong> ØªØ­Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ø®ØªØ± <strong style="color:var(--accent)">"Show transcript"</strong>ØŒ Ø«Ù… Ø­Ø¯Ø¯ ÙƒÙ„ Ø§Ù„Ù†Øµ <strong style="color:var(--accent)">(Ctrl+A)</strong> ÙˆØ§Ù†Ø³Ø®Ù‡ <strong style="color:var(--accent)">(Ctrl+C)</strong>.</p>
          <div class="tip">ğŸ’¡ ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØªØ§Øª Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª Ù‚Ø¨Ù„ Ù…Ø§ ØªÙ†Ø³Ø®</div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="guide-step">
        <div class="guide-num">Ù¢</div>
        <div class="guide-content">
          <h3>Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</h3>
          <p>Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª ÙÙŠ Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©ØŒ Ø«Ù… Ø§Ø¶ØºØ· <strong style="color:var(--accent)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© â–¶</strong>.</p>
          <div class="guide-img">
            <div class="guide-img-inner">
              <div class="sim-bar">
                <div class="sim-input">https://www.youtube.com/watch?v=...</div>
                <div class="sim-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© â–¶</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="guide-step">
        <div class="guide-num">Ù£</div>
        <div class="guide-content">
          <h3>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬ Ù…Ø¹ Ø§Ù„Ù…Ø´ØºÙ„</h3>
          <p>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ´ØªØºÙ„ ÙˆØ§Ù„Ù†Øµ ÙŠØªØªØ¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø·Ø± Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.</p>
          <div class="guide-img">
            <div class="guide-img-inner">
              <div class="sim-line hl">
                <span class="sim-time">0:03</span>
                <div><div class="sim-text">Self-confidence is the belief</div></div>
                <div class="sim-icons">
                  <div class="sim-icon">ğŸ”</div>
                  <div class="sim-icon gold">â­</div>
                </div>
              </div>
              <div class="sim-line">
                <span class="sim-time">0:06</span>
                <div><div class="sim-text">in your own abilities and judgment</div></div>
                <div class="sim-icons">
                  <div class="sim-icon">ğŸ”</div>
                  <div class="sim-icon">â­</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4 -->
      <div class="guide-step">
        <div class="guide-num">Ù¤</div>
        <div class="guide-content">
          <h3>Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬</h3>
          <p>Ø¹Ù†Ø¯Ùƒ Ù£ Ø£Ø¯ÙˆØ§Øª Ù…Ù‡Ù…Ø© Ù„ÙƒÙ„ Ø³Ø·Ø±:</p>
          <p style="margin-top:.6rem">
            <strong style="color:var(--gold)">ğŸ” ØªÙƒØ±Ø§Ø±</strong> â€” ÙŠÙƒØ±Ø± Ø§Ù„Ø³Ø·Ø± Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­ØªÙ‰ ØªØªÙ‚Ù†Ù‡<br>
            <strong style="color:#f9ca24">â­ Ù…ÙØ¶Ù„Ø©</strong> â€” ÙŠØ­ÙØ¸ Ø§Ù„Ø¬Ù…Ù„Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù…ÙØ¶Ù„Ø©" Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©<br>
            <strong style="color:var(--accent)">ğŸŒ ØªØ±Ø¬Ù…</strong> â€” ÙŠØªØ±Ø¬Ù… ÙƒÙ„ Ø§Ù„Ø³Ø·ÙˆØ± Ù„Ù„Ø¹Ø±Ø¨ÙŠ Ø¯ÙØ¹Ø© ÙˆØ­Ø¯Ø©
          </p>
          <div class="tip">ğŸ’¡ Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø³Ø±Ø¹Ø© Ù„Ù€ 0.75Ã— Ø£Ùˆ 0.5Ã— ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø­ØªÙ‰ ØªØ¹ØªØ§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ù‚</div>
        </div>
      </div>

      <!-- Step 5 -->
      <div class="guide-step">
        <div class="guide-num">Ù¥</div>
        <div class="guide-content">
          <h3>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬ Ø§Ù„ØµØ­ÙŠØ­Ø©</h3>
          <p>
            Ù¡. <strong>Ø§Ø³ØªÙ…Ø¹</strong> Ù„Ù„Ø³Ø·Ø± ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªÙ‚Ù„Ø¯<br>
            Ù¢. <strong>ÙƒØ±Ø±Ù‡</strong> Ø¨Ù†ÙØ³ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¹ ÙˆØ§Ù„Ù†Ø¨Ø±Ø© Ø¨ØµÙˆØª Ø¹Ø§Ù„ÙŠ<br>
            Ù£. <strong>Ù‚Ø§Ø±Ù†</strong> Ù†Ø·Ù‚Ùƒ Ù…Ø¹ Ø§Ù„Ø£ØµÙ„<br>
            Ù¤. <strong>ÙƒØ±Ø±</strong> Ø­ØªÙ‰ ØªØ­Ø³ Ø¥Ù† Ù†Ø·Ù‚Ùƒ Ø·Ø¨ÙŠØ¹ÙŠ<br>
            Ù¥. Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ
          </p>
          <div class="tip">ğŸ¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¹ ÙˆØ§Ù„ØªÙ†ØºÙŠÙ… Ø£Ù‡Ù… Ù…Ù† Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±ÙÙŠ Ù„Ù„ÙƒÙ„Ù…Ø§Øª</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let player     = null;
let lines      = [];
let loopIdx    = null;
let tracker    = null;
let curSpeed   = 1;
let showAr     = false;

// â”€â”€â”€ URL helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getYTId(url) {
  const m = url.match(/(?:youtube\.com\/(?:watch\?(?:.*&)?v=|shorts\/|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}

function checkUrl() {
  const pill = document.getElementById('urlPill');
  const url  = document.getElementById('videoUrl').value.trim();
  pill.classList.remove('hidden');
  if (getYTId(url)) {
    pill.textContent = 'âœ“ ØµØ­ÙŠØ­';
    pill.className = 'pill-ok';
  } else {
    pill.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·';
    pill.className = 'pill-warn';
  }
}

function checkTr() {
  const pill = document.getElementById('trPill');
  const raw  = document.getElementById('trInput').value.trim();
  pill.classList.remove('hidden');
  const p = parseTranscript(raw);
  if (p.length) {
    pill.textContent = `âœ“ ${p.length} Ø³Ø·Ø±`;
    pill.className = 'pill-ok';
  } else {
    pill.textContent = raw ? 'ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' : 'ÙØ§Ø¶ÙŠ';
    pill.className = 'pill-warn';
  }
}

// â”€â”€â”€ Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTranscript(raw) {
  const rows = raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').map(r=>r.trim()).filter(Boolean);
  const timeRE = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/;
  const result = [];
  let i = 0;
  while (i < rows.length) {
    const tm = rows[i].match(timeRE);
    if (tm) {
      const secs = tm[3]!==undefined ? +tm[1]*3600+ +tm[2]*60+ +tm[3] : +tm[1]*60+ +tm[2];
      let parts=[]; i++;
      while (i<rows.length && !rows[i].match(timeRE)) { parts.push(rows[i]); i++; }
      const text=parts.join(' ').trim();
      if (text) result.push({time:secs,en:text,ar:''});
    } else {
      const inl = rows[i].match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s+(.+)$/);
      if (inl) {
        const secs = inl[3]!==undefined ? +inl[1]*3600+ +inl[2]*60+ +inl[3] : +inl[1]*60+ +inl[2];
        result.push({time:secs,en:inl[4].trim(),ar:''});
      }
      i++;
    }
  }
  return result;
}

// â”€â”€â”€ Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startSession() {
  const url = document.getElementById('videoUrl').value.trim();
  const raw = document.getElementById('trInput').value.trim();
  const ytId = getYTId(url);
  if (!ytId) { alert('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ â€” ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨'); return; }
  lines = parseTranscript(raw);
  document.getElementById('setupSection').classList.add('hidden');
  document.getElementById('playerSection').classList.remove('hidden');
  renderLines();
  setTimeout(() => loadYT(ytId), 200);
  document.getElementById('playerSection').scrollIntoView({behavior:'smooth'});
}

function backToSetup() {
  document.getElementById('setupSection').classList.remove('hidden');
  document.getElementById('playerSection').classList.add('hidden');
  if (tracker) clearInterval(tracker);
  lines=[]; loopIdx=null; favSet=new Set();
  document.getElementById('loopBadge').classList.remove('on');
  document.getElementById('favCount').style.display='none';
}

function clearAll() {
  document.getElementById('videoUrl').value='';
  document.getElementById('trInput').value='';
  document.getElementById('urlPill').classList.add('hidden');
  document.getElementById('trPill').classList.add('hidden');
}

// â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let favSet = new Set();

function toggleFav(idx, e) {
  e.stopPropagation();
  const btn = document.getElementById('star-' + idx);
  if (favSet.has(idx)) {
    favSet.delete(idx);
    btn && btn.classList.remove('on');
  } else {
    favSet.add(idx);
    btn && btn.classList.add('on');
  }
  updateFavCount();
  renderFav();
}

function updateFavCount() {
  const countEl = document.getElementById('favCount');
  if (!countEl) return;
  if (favSet.size > 0) {
    countEl.textContent = favSet.size;
    countEl.style.display = 'inline';
  } else {
    countEl.style.display = 'none';
  }
}

function renderFav() {
  const body = document.getElementById('favBody');
  if (!body) return;
  if (favSet.size === 0) {
    body.innerHTML = '<div class="fav-empty"><div class="fav-icon">â­</div><p>Ø§Ø¶ØºØ· â­ Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠ Ø³Ø·Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ÙØ¶Ù„Ø©</p></div>';
    return;
  }
  body.innerHTML = '';
  const showArNow = document.getElementById('arToggle') && document.getElementById('arToggle').checked;
  [...favSet].sort((a,b) => a-b).forEach(i => {
    const line = lines[i];
    if (!line) return;
    const div = document.createElement('div');
    div.className = 't-line';
    div.innerHTML = `
      <span class="t-time">${fmt(line.time)}</span>
      <div class="t-content" style="flex:1">
        <div class="t-en">${esc(line.en)}</div>
        ${line.ar ? `<div class="t-ar" style="display:${showArNow?'block':'none'}">${esc(line.ar)}</div>` : ''}
      </div>
      <button class="rep-btn" onclick="toggleLoop(${i},event)" title="ÙƒØ±Ø±">ğŸ”</button>
      <button class="star-btn on" onclick="toggleFav(${i},event)" title="Ø£Ø²Ù„ Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©">â­</button>`;
    div.addEventListener('click', e => { if (!e.target.closest('.rep-btn') && !e.target.closest('.star-btn')) seekTo(i); });
    body.appendChild(div);
  });
}

function switchTab(tab, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(tab === 'all' ? 'paneAll' : 'paneFav').classList.add('active');
  if (tab === 'fav') renderFav();
}

// â”€â”€â”€ YouTube â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadYT(ytId) {
  const c = document.getElementById('ytContainer');
  c.innerHTML='';
  c.style.position='absolute';
  c.style.inset='0';

  if (window.YT && window.YT.Player) {
    makePlayer(ytId);
  } else {
    window._ytId = ytId;
    if (!document.getElementById('yt-script')) {
      const s = document.createElement('script');
      s.id='yt-script'; s.src='https://www.youtube.com/iframe_api';
      document.head.appendChild(s);
    }
    window.onYouTubeIframeAPIReady = () => makePlayer(window._ytId);
  }
}

function makePlayer(ytId) {
  if (player && player.destroy) player.destroy();
  const div = document.createElement('div');
  div.id='yt-inner';
  document.getElementById('ytContainer').appendChild(div);
  player = new YT.Player('yt-inner', {
    videoId: ytId,
    width: '100%', height: '100%',
    playerVars: {autoplay:0, rel:0, modestbranding:1},
    events: { onReady: e => { e.target.setPlaybackRate(curSpeed); startTracker(); } }
  });
}

// â”€â”€â”€ Tracker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTracker() {
  if (tracker) clearInterval(tracker);
  tracker = setInterval(() => {
    if (!player || !player.getCurrentTime) return;
    let t=0;
    try { t=player.getCurrentTime(); } catch(e) { return; }
    highlightLine(t);
    handleLoop(t);
  }, 250);
}

let userScrolling = false;
let userScrollTimer = null;

// Ø§ÙƒØªØ´Ø§Ù Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…Ø±Ø± ÙŠØ¯Ù‡
document.addEventListener('DOMContentLoaded', () => {
  const trBody = document.getElementById('trBody');
  if (trBody) {
    trBody.addEventListener('scroll', () => {
      userScrolling = true;
      clearTimeout(userScrollTimer);
      // Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ù…Ù† ØªÙˆÙ‚Ù Ø§Ù„ÙŠØ¯ ÙŠØ±Ø¬Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      userScrollTimer = setTimeout(() => { userScrolling = false; }, 2000);
    }, { passive: true });
  }
});

function highlightLine(t) {
  if (!lines.length) return;
  let ai = 0;
  for (let i = 0; i < lines.length; i++) { if (t >= lines[i].time) ai = i; }

  let changed = false;
  document.querySelectorAll('.t-line').forEach((el, i) => {
    const was = el.classList.contains('active');
    el.classList.toggle('active', i === ai);
    if (i === ai && !was) changed = true;
  });

  // Ù…Ø±Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ùˆ ÙŠÙ…Ø±Ø±
  if (changed && !userScrolling) {
    const activeLine = document.getElementById('tline-' + ai);
    const trBody = document.getElementById('trBody');
    if (activeLine && trBody) {
      const lineTop    = activeLine.offsetTop;
      const lineHeight = activeLine.offsetHeight;
      const bodyScroll = trBody.scrollTop;
      const bodyHeight = trBody.clientHeight;
      // Ù„Ùˆ Ø§Ù„Ø³Ø·Ø± Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø±Ø¤ÙŠØ©
      if (lineTop < bodyScroll + 60 || lineTop + lineHeight > bodyScroll + bodyHeight - 60) {
        trBody.scrollTo({ top: lineTop - bodyHeight / 2 + lineHeight / 2, behavior: 'smooth' });
      }
    }
  }
}

function handleLoop(t) {
  if (loopIdx===null) return;
  const line = lines[loopIdx];
  const end  = lines[loopIdx+1] ? lines[loopIdx+1].time : line.time+7;
  if (t>=end) player.seekTo(line.time, true);
}

// â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSpeed(s, btn) {
  curSpeed=s;
  document.querySelectorAll('.speed-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if (player && player.setPlaybackRate) player.setPlaybackRate(s);
}

function toggleAr() {
  showAr = document.getElementById('arToggle').checked;
  document.getElementById('trBody').classList.toggle('show-ar', showAr);
}

function toggleLoop(idx, e) {
  e.stopPropagation();
  const badge = document.getElementById('loopBadge');
  if (loopIdx===idx) {
    loopIdx=null; badge.classList.remove('on');
    document.querySelectorAll('.rep-btn').forEach(b=>b.classList.remove('on'));
    return;
  }
  loopIdx=idx; badge.classList.add('on');
  document.querySelectorAll('.rep-btn').forEach(b=>b.classList.remove('on'));
  e.currentTarget.classList.add('on');
  seekTo(idx);
}

function seekTo(idx) {
  if (!player || !player.seekTo) return;
  player.seekTo(lines[idx].time, true);
  player.playVideo && player.playVideo();
}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLines() {
  const body = document.getElementById('trBody');
  if (!lines.length) {
    body.innerHTML='<div style="text-align:center;padding:2.5rem;color:var(--muted)"><div style="font-size:2.2rem;margin-bottom:.7rem">âš ï¸</div><p>Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†Ù‚Ø±Ø£ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</p></div>';
    return;
  }
  body.innerHTML='';
  lines.forEach((line,i) => {
    const div=document.createElement('div');
    div.className='t-line'; div.id='tline-'+i;
    div.innerHTML=`
      <span class="t-time">${fmt(line.time)}</span>
      <div class="t-content" style="flex:1">
        <div class="t-en">${esc(line.en)}</div>
        <div class="t-ar"></div>
      </div>
      <button class="rep-btn" onclick="toggleLoop(${i},event)" title="ÙƒØ±Ø±">ğŸ”</button>
      <button class="star-btn" id="star-${i}" onclick="toggleFav(${i},event)" title="Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©">â­</button>`;
    div.addEventListener('click', e => {
      if (!e.target.closest('.rep-btn') && !e.target.closest('.star-btn')) seekTo(i);
    });
    body.appendChild(div);
  });
}

// â”€â”€â”€ Translation (Google Translate ØºÙŠØ± Ø±Ø³Ù…ÙŠ â€” Ù…Ø¬Ø§Ù†ÙŠ Ø¨Ù„Ø§ API key) â”€â”€â”€
async function translateOne(text) {
  // Ù†Ø³ØªØ®Ø¯Ù… Google Translate endpoint ØºÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠ â€” ÙŠØ´ØªØºÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
  const url = 'https://translate.googleapis.com/translate_a/single'
    + '?client=gtx&sl=en&tl=ar&dt=t&q=' + encodeURIComponent(text);
  const res = await fetch(url);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const data = await res.json();
  // Ø§Ù„Ø±Ø¯: [[[translated, original, ...]]]
  return data[0].map(x => x[0]).join('');
}

async function translateAll() {
  const btn = document.getElementById('trBtn');
  const untranslated = lines.filter(l => !l.ar);
  if (!untranslated.length) { showArTranslations(); return; }

  btn.disabled = true;
  btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©...';
  hideErr();

  const items = lines.map((l, i) => ({ i, en: l.en })).filter(x => !lines[x.i].ar);
  let done = 0;

  try {
    for (const item of items) {
      const translated = await translateOne(lines[item.i].en);
      lines[item.i].ar = translated;
      done++;
      btn.textContent = 'â³ ' + done + ' / ' + items.length;
      // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ block
      await new Promise(r => setTimeout(r, 100));
    }
    showArTranslations();
    btn.textContent = 'âœ“ ØªÙ…Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©';
    setTimeout(() => { btn.textContent = 'ğŸŒ ØªØ±Ø¬Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'; btn.disabled = false; }, 2500);
  } catch (err) {
    showErr('âŒ ' + err.message);
    showArTranslations();
    btn.textContent = 'âŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
    btn.disabled = false;
  }
}

function showArTranslations() {
  lines.forEach((line,i) => {
    const el = document.querySelector('#tline-'+i+' .t-ar');
    if (el) el.textContent = line.ar || '';
  });
  document.getElementById('arToggle').checked=true;
  showAr=true;
  document.getElementById('trBody').classList.add('show-ar');
}

function showErr(msg) {
  const box=document.getElementById('errBox');
  box.textContent=msg; box.classList.remove('hidden');
}
function hideErr() { document.getElementById('errBox').classList.add('hidden'); }

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(s) {
  const m=Math.floor(s/60), sec=s%60;
  return `${m}:${sec.toString().padStart(2,'0')}`;
}
function esc(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Help Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openHelp()  { document.getElementById('helpModal').classList.remove('hidden'); document.body.style.overflow='hidden'; }
function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); document.body.style.overflow=''; }
function closeHelpOutside(e) { if (e.target.id==='helpModal') closeHelp(); }
document.addEventListener('keydown', e => { if (e.key==='Escape') closeHelp(); });
</script>
</body>
</html>
