<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shadow English â€” ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --card: #1a2235;
    --accent: #00d4aa;
    --accent3: #ffd93d;
    --text: #e8eaf0;
    --muted: #6b7a99;
    --border: #2a3550;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Tajawal', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 600px 400px at 80% 20%, rgba(0,212,170,0.07) 0%, transparent 70%),
      radial-gradient(ellipse 500px 300px at 10% 80%, rgba(255,107,107,0.05) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    text-align: center;
    margin-bottom: 2.5rem;
    animation: fadeDown 0.7s ease;
  }

  .badge {
    display: inline-block;
    background: rgba(0,212,170,0.12);
    border: 1px solid rgba(0,212,170,0.35);
    color: var(--accent);
    font-size: 0.72rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    padding: 0.35rem 1.1rem;
    border-radius: 100px;
    margin-bottom: 0.9rem;
    font-family: 'Space Mono', monospace;
  }

  .header h1 {
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 900;
    line-height: 1.1;
  }

  .header h1 span { color: var(--accent); }
  .header p { color: var(--muted); font-size: 1rem; margin-top: 0.5rem; }

  .dedication {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    margin-top: 1.2rem;
    background: rgba(0,212,170,0.06);
    border: 1px solid rgba(0,212,170,0.2);
    border-radius: 100px;
    padding: 0.5rem 1.2rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .ded-label {
    font-size: 0.82rem;
    color: var(--muted);
  }

  .ded-name {
    font-size: 0.95rem;
    color: var(--text);
    font-weight: 700;
  }

  .ded-link {
    font-size: 0.82rem;
    color: var(--accent);
    text-decoration: none;
    border: 1px solid rgba(0,212,170,0.35);
    border-radius: 100px;
    padding: 0.2rem 0.8rem;
    transition: all 0.2s;
    font-family: 'Space Mono', monospace;
  }

  .ded-link:hover {
    background: rgba(0,212,170,0.12);
    border-color: var(--accent);
  }

  /* â”€â”€ Steps â”€â”€ */
  .steps {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    animation: fadeUp 0.6s ease 0.1s both;
  }

  .step {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.1rem;
    text-align: center;
  }

  .step-num {
    width: 30px; height: 30px;
    background: rgba(0,212,170,0.12);
    border: 1px solid var(--accent);
    color: var(--accent);
    border-radius: 50%;
    font-size: 0.82rem;
    font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 0.6rem;
    font-family: 'Space Mono', monospace;
  }

  .step-title { font-size: 0.88rem; font-weight: 700; margin-bottom: 0.25rem; }
  .step-desc { font-size: 0.76rem; color: var(--muted); line-height: 1.5; }

  /* â”€â”€ Card â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    margin-bottom: 1.5rem;
    overflow: hidden;
    animation: fadeUp 0.6s ease 0.2s both;
  }

  .card-header {
    padding: 0.9rem 1.4rem;
    border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,0.18);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .card-title {
    font-size: 0.8rem;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-family: 'Space Mono', monospace;
  }

  .card-body { padding: 1.3rem; }

  /* â”€â”€ Inputs â”€â”€ */
  .url-row {
    display: flex;
    gap: 0.8rem;
    flex-wrap: wrap;
  }

  .url-input {
    flex: 1;
    min-width: 200px;
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 0.85rem 1.1rem;
    color: var(--text);
    font-size: 0.92rem;
    font-family: 'Space Mono', monospace;
    direction: ltr;
    outline: none;
    transition: border-color 0.2s;
  }

  .url-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,170,0.1);
  }

  .url-input::placeholder { color: var(--muted); }

  .btn {
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 12px;
    padding: 0.85rem 1.7rem;
    font-size: 0.93rem;
    font-weight: 700;
    font-family: 'Tajawal', sans-serif;
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .btn:hover {
    background: #00f0c0;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,212,170,0.35);
  }

  .btn-outline {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
  }

  .btn-outline:hover {
    background: rgba(0,212,170,0.08);
    box-shadow: none;
    transform: none;
  }

  .transcript-input {
    width: 100%;
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.1rem;
    color: var(--text);
    font-size: 0.86rem;
    font-family: 'Space Mono', monospace;
    direction: ltr;
    text-align: left;
    resize: vertical;
    min-height: 170px;
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.7;
  }

  .transcript-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,170,0.1);
  }

  .transcript-input::placeholder { color: var(--muted); font-size: 0.8rem; }

  .how-to {
    background: rgba(0,212,170,0.04);
    border: 1px solid rgba(0,212,170,0.14);
    border-radius: 12px;
    padding: 1rem 1.2rem;
    margin-top: 1rem;
    font-size: 0.82rem;
    color: var(--muted);
    line-height: 1.9;
    direction: rtl;
  }

  .how-to strong { color: var(--accent); }

  .row-actions {
    display: flex;
    gap: 0.8rem;
    margin-top: 1rem;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  /* â”€â”€ Status pill â”€â”€ */
  .status-pill {
    font-size: 0.72rem;
    padding: 0.22rem 0.8rem;
    border-radius: 100px;
    font-family: 'Space Mono', monospace;
    display: none;
  }

  .pill-ok   { background: rgba(0,212,170,0.1); color: var(--accent);  border: 1px solid rgba(0,212,170,0.3); }
  .pill-warn { background: rgba(255,217,61,0.1); color: var(--accent3); border: 1px solid rgba(255,217,61,0.3); }

  /* â”€â”€ Video player â”€â”€ */
  .video-container {
    position: relative;
    width: 100%;
    padding-top: 56.25%;
    background: #000;
  }

  .video-container iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  /* â”€â”€ Controls bar â”€â”€ */
  .controls-bar {
    padding: 0.9rem 1.4rem;
    display: flex;
    align-items: center;
    gap: 1.3rem;
    flex-wrap: wrap;
    border-top: 1px solid var(--border);
    background: rgba(0,0,0,0.18);
  }

  .ctrl-group { display: flex; align-items: center; gap: 0.45rem; }

  .ctrl-label {
    font-size: 0.75rem;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
  }

  .speed-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 8px;
    padding: 0.3rem 0.65rem;
    font-size: 0.78rem;
    cursor: pointer;
    font-family: 'Space Mono', monospace;
    transition: all 0.14s;
  }

  .speed-btn:hover { border-color: var(--accent); color: var(--accent); }
  .speed-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }

  .toggle-sw { display: flex; align-items: center; gap: 0.55rem; cursor: pointer; }
  .toggle-sw input { display: none; }

  .toggle-track {
    width: 38px; height: 21px;
    background: var(--border);
    border-radius: 100px;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .toggle-track::after {
    content: '';
    position: absolute;
    width: 15px; height: 15px;
    background: #fff;
    border-radius: 50%;
    top: 3px; left: 3px;
    transition: transform 0.2s;
  }

  .toggle-sw input:checked + .toggle-track { background: var(--accent); }
  .toggle-sw input:checked + .toggle-track::after { transform: translateX(17px); }
  .toggle-label { font-size: 0.83rem; }

  /* loop indicator */
  .loop-badge {
    display: none;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.75rem;
    color: var(--accent3);
    background: rgba(255,217,61,0.08);
    border: 1px solid rgba(255,217,61,0.3);
    padding: 0.22rem 0.65rem;
    border-radius: 100px;
    font-family: 'Space Mono', monospace;
  }

  .loop-badge.on { display: inline-flex; }

  .pulse-dot {
    width: 6px; height: 6px;
    background: var(--accent3);
    border-radius: 50%;
    animation: pulse 1s ease infinite;
  }

  /* â”€â”€ Transcript lines â”€â”€ */
  .transcript-body {
    padding: 0.9rem;
    max-height: 440px;
    overflow-y: auto;
  }

  .transcript-body::-webkit-scrollbar { width: 5px; }
  .transcript-body::-webkit-scrollbar-track { background: transparent; }
  .transcript-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .t-line {
    display: flex;
    gap: 0.7rem;
    padding: 0.75rem 0.85rem;
    border-radius: 11px;
    cursor: pointer;
    transition: all 0.13s;
    margin-bottom: 0.18rem;
    border: 1px solid transparent;
    align-items: flex-start;
  }

  .t-line:hover { background: rgba(0,212,170,0.05); border-color: rgba(0,212,170,0.2); }
  .t-line.active { background: rgba(0,212,170,0.11); border-color: rgba(0,212,170,0.42); }

  .t-time {
    font-size: 0.7rem;
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    white-space: nowrap;
    margin-top: 3px;
    min-width: 40px;
  }

  .t-content { flex: 1; }

  .t-en {
    font-size: 0.94rem;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    line-height: 1.55;
    direction: ltr;
    text-align: left;
  }

  .t-ar {
    font-size: 0.86rem;
    color: var(--muted);
    margin-top: 0.28rem;
    direction: rtl;
    text-align: right;
    display: none;
    font-family: 'Tajawal', sans-serif;
  }

  .show-tr .t-ar { display: block; }

  .rep-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 7px;
    width: 27px; height: 27px;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.13s;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .rep-btn:hover { border-color: var(--accent3); color: var(--accent3); }
  .rep-btn.on { border-color: var(--accent3); color: var(--accent3); background: rgba(255,217,61,0.1); }

  /* Empty */
  .empty {
    text-align: center;
    padding: 2.5rem;
    color: var(--muted);
  }

  .empty-icon { font-size: 2.2rem; margin-bottom: 0.7rem; }

  .hidden { display: none; }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-18px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(18px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50%       { opacity: 0.4; transform: scale(0.6); }
  }

  @media (max-width: 640px) {
    .steps { flex-direction: column; }
    .url-row { flex-direction: column; }
    .controls-bar { gap: 0.8rem; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="badge">ğŸ§ Shadowing Method</div>
    <h1>ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©<br><span>Ø¨Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ø¬</span></h1>
    <p>Ù‚Ù„Ù‘Ø¯ Ø§Ù„Ù†Ø·Ù‚ Ø³Ø·Ø± Ø¨Ø³Ø·Ø± â€” Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø³Ø±Ø¹ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù„ØºØ©</p>
    <div class="dedication">
      <span class="ded-label">Ø¥Ù‡Ø¯Ø§Ø¡ Ù…Ù†</span>
      <strong class="ded-name">Ø³Ù„Ø·Ø§Ù† Ø¨Ù† Ø¹Ø§ÙŠØ¯</strong>
      <a href="https://sultan-ayed.github.io/my/" target="_blank" class="ded-link">
        ğŸŒ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
      </a>
    </div>
  </div>

  <!-- Steps -->
  <div class="steps">
    <div class="step">
      <div class="step-num">Ù¡</div>
      <div class="step-title">Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>
      <div class="step-desc">Ø£ÙŠ Ù…Ù‚Ø·Ø¹ ÙŠÙˆØªÙŠÙˆØ¨</div>
    </div>
    <div class="step">
      <div class="step-num">Ù¢</div>
      <div class="step-title">Ø§Ù†Ø³Ø® Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</div>
      <div class="step-desc">â‹¯ â† Show transcript â† Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</div>
    </div>
    <div class="step">
      <div class="step-num">Ù£</div>
      <div class="step-title">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø§Ø¯ÙˆÙŠÙ†Ù‚!</div>
      <div class="step-desc">Ø§Ø³Ù…Ø¹ â† ÙˆÙ‚Ù‘Ù â† Ù‚Ù„Ù‘Ø¯ â† ÙƒØ±Ø± ğŸ¯</div>
    </div>
  </div>

  <!-- Card 1: URL -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“º Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
      <span class="status-pill" id="urlPill"></span>
    </div>
    <div class="card-body">
      <div class="url-row">
        <input type="text" class="url-input" id="videoUrl"
          placeholder="https://www.youtube.com/watch?v=..."
          oninput="checkUrl()">
        <button class="btn" onclick="startSession()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© â–¶</button>
      </div>
    </div>
  </div>

  <!-- Card 2: Transcript paste -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª</span>
      <span class="status-pill" id="trPill"></span>
    </div>
    <div class="card-body">
      <textarea class="transcript-input" id="trInput"
        oninput="checkTranscript()"
        placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù…Ù†Ø³ÙˆØ® Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨...

Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØµØ­ÙŠØ­:
0:00
Hello and welcome back everyone.
0:04
Today we will practice English together.
0:08
Let's begin with some basic phrases."></textarea>

      <div class="how-to">
        <strong>ğŸ“‹ ÙƒÙŠÙ ØªÙ†Ø³Ø® Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ØŸ</strong><br>
        Ù¡. Ø§ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­<br>
        Ù¢. ØªØ­Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <strong>â‹¯ (Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø·)</strong><br>
        Ù£. Ø§Ø®ØªØ± <strong>"Show transcript"</strong><br>
        Ù¤. Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØªØ§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†<br>
        Ù¥. <strong>Ø­Ø¯Ø¯ Ø§Ù„ÙƒÙ„ ÙˆØ§Ù†Ø³Ø®Ù‡ (Ctrl+A Ø«Ù… Ctrl+C)</strong> ÙˆØ§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§
      </div>

      <div class="row-actions">
        <button class="btn btn-outline" onclick="clearAll()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <button class="btn" onclick="startSession()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© â–¶</button>
      </div>
    </div>
  </div>

  <!-- Player card -->
  <div class="card hidden" id="playerCard">
    <div class="card-header">
      <span class="card-title">ğŸ¬ Ø§Ù„Ù…Ø´ØºÙ„</span>
      <div class="loop-badge" id="loopBadge">
        <div class="pulse-dot"></div>
        ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø·Ø±
      </div>
    </div>
    <div class="video-container" id="videoContainer"></div>
    <div class="controls-bar">
      <div class="ctrl-group">
        <span class="ctrl-label">Ø§Ù„Ø³Ø±Ø¹Ø©:</span>
        <button class="speed-btn" onclick="setSpeed(0.5,this)">0.5Ã—</button>
        <button class="speed-btn" onclick="setSpeed(0.75,this)">0.75Ã—</button>
        <button class="speed-btn active" onclick="setSpeed(1,this)">1Ã—</button>
        <button class="speed-btn" onclick="setSpeed(1.25,this)">1.25Ã—</button>
        <button class="speed-btn" onclick="setSpeed(1.5,this)">1.5Ã—</button>
      </div>
      <label class="toggle-sw">
        <input type="checkbox" id="trToggle" onchange="toggleTr()">
        <div class="toggle-track"></div>
        <span class="toggle-label">ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠ</span>
      </label>
    </div>
  </div>

  <!-- Transcript viewer -->
  <div class="card hidden" id="trCard">
    <div class="card-header">
      <span class="card-title">ğŸ“„ Ø§Ù„Ù†Øµ â€” Ø³Ø·Ø± Ø¨Ø³Ø·Ø±</span>
      <div style="display:flex; align-items:center; gap:0.8rem; flex-wrap:wrap;">
        <span style="font-size:0.72rem; color:var(--muted); font-family:'Space Mono',monospace">
          Ø§Ø¶ØºØ· Ø§Ù„Ø³Ø·Ø± â† Ø§Ù†ØªÙ‚Ù„ &nbsp;|&nbsp; ğŸ” â† ÙƒØ±Ø±
        </span>
        <button class="btn" id="translateBtn" onclick="translateAll()" style="padding:0.4rem 1rem; font-size:0.82rem; border-radius:9px;">
          ğŸŒ ØªØ±Ø¬Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
        </button>
      </div>
    </div>
    <div class="transcript-body" id="trBody">
      <div class="empty"><div class="empty-icon">ğŸ¬</div><p>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ø³Ø·ÙˆØ±</p></div>
    </div>
  </div>

</div>

<script>
  let player        = null;
  let speed         = 1;
  let loopIdx       = null;
  let loopTimer     = null;
  let lines         = [];
  let tracker       = null;

  // â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getYTId(url) {
    const m = url.match(/(?:youtube\.com\/(?:watch\?(?:.*&)?v=|shorts\/|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    return m ? m[1] : null;
  }

  function checkUrl() {
    const pill = document.getElementById('urlPill');
    const url  = document.getElementById('videoUrl').value.trim();
    pill.style.display = 'inline-block';
    if (getYTId(url)) {
      pill.textContent = 'âœ“ ØµØ­ÙŠØ­';
      pill.className = 'status-pill pill-ok';
    } else {
      pill.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·';
      pill.className = 'status-pill pill-warn';
    }
  }

  function checkTranscript() {
    const pill = document.getElementById('trPill');
    const raw  = document.getElementById('trInput').value.trim();
    pill.style.display = 'inline-block';
    if (!raw) { pill.textContent = 'ÙØ§Ø¶ÙŠ'; pill.className = 'status-pill pill-warn'; return; }
    const parsed = parseTranscript(raw);
    if (parsed.length) {
      pill.textContent = `âœ“ ${parsed.length} Ø³Ø·Ø±`;
      pill.className = 'status-pill pill-ok';
    } else {
      pill.textContent = 'ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      pill.className = 'status-pill pill-warn';
    }
  }

  // â”€â”€ Parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Handles YouTube's "Toggle timestamps" output:
  //   0:00\nText\n0:05\nMore text
  // Also handles inline: "0:05 text"
  function parseTranscript(raw) {
    const result = [];
    // Normalise line endings, split
    const rows = raw.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').map(r => r.trim()).filter(r => r);

    const timeRE = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/;
    let i = 0;

    while (i < rows.length) {
      const tm = rows[i].match(timeRE);
      if (tm) {
        const secs = tm[3] !== undefined
          ? +tm[1]*3600 + +tm[2]*60 + +tm[3]
          : +tm[1]*60  + +tm[2];

        // collect text lines until next timestamp or end
        let textParts = [];
        i++;
        while (i < rows.length && !rows[i].match(timeRE)) {
          textParts.push(rows[i]);
          i++;
        }
        const text = textParts.join(' ').trim();
        if (text) result.push({ time: secs, en: text, ar: '' });
      } else {
        // inline: "0:05 text here"
        const inl = rows[i].match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s+(.+)$/);
        if (inl) {
          const secs = inl[3] !== undefined
            ? +inl[1]*3600 + +inl[2]*60 + +inl[3]
            : +inl[1]*60  + +inl[2];
          result.push({ time: secs, en: inl[4].trim(), ar: '' });
        }
        i++;
      }
    }
    return result;
  }

  // â”€â”€ Session Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startSession() {
    const url = document.getElementById('videoUrl').value.trim();
    const raw = document.getElementById('trInput').value.trim();

    if (!url) { alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ'); return; }
    const ytId = getYTId(url);
    if (!ytId) { alert('Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ â€” ØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨'); return; }

    lines = parseTranscript(raw);

    document.getElementById('playerCard').classList.remove('hidden');
    document.getElementById('trCard').classList.remove('hidden');

    renderLines();
    loadYT(ytId);

    setTimeout(() => {
      document.getElementById('playerCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 350);
  }

  // â”€â”€ YouTube IFrame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadYT(ytId) {
    document.getElementById('videoContainer').innerHTML = '';
    if (window.YT && window.YT.Player) {
      makePlayer(ytId);
    } else {
      window._pendingYTId = ytId;
      if (!document.getElementById('ytScript')) {
        const s = document.createElement('script');
        s.id  = 'ytScript';
        s.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(s);
      }
      window.onYouTubeIframeAPIReady = () => makePlayer(window._pendingYTId);
    }
  }

  function makePlayer(ytId) {
    if (player && player.destroy) { player.destroy(); }
    const div = document.createElement('div');
    div.id = 'yt';
    document.getElementById('videoContainer').appendChild(div);

    player = new YT.Player('yt', {
      videoId: ytId,
      playerVars: { autoplay: 0, rel: 0, modestbranding: 1 },
      events: {
        onReady: () => {
          player.setPlaybackRate(speed);
          startTracker();
        }
      }
    });
  }

  // â”€â”€ Tracker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startTracker() {
    if (tracker) clearInterval(tracker);
    tracker = setInterval(() => {
      if (!player || !player.getCurrentTime) return;
      let t = 0;
      try { t = player.getCurrentTime(); } catch(e) { return; }
      highlightActive(t);
      if (loopIdx !== null) doLoop(t);
    }, 250);
  }

  function highlightActive(t) {
    if (!lines.length) return;
    let active = 0;
    for (let i = 0; i < lines.length; i++) {
      if (t >= lines[i].time) active = i;
    }
    document.querySelectorAll('.t-line').forEach((el, i) => {
      const was = el.classList.contains('active');
      el.classList.toggle('active', i === active);
      if (i === active && !was) {
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
  }

  function doLoop(t) {
    const line = lines[loopIdx];
    const end  = lines[loopIdx + 1] ? lines[loopIdx + 1].time : line.time + 7;
    if (t >= end) {
      player.seekTo(line.time, true);
    }
  }

  // â”€â”€ Speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setSpeed(s, btn) {
    speed = s;
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (player && player.setPlaybackRate) player.setPlaybackRate(s);
  }

  // â”€â”€ Translation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleTr() {
    const on = document.getElementById('trToggle').checked;
    document.getElementById('trBody').classList.toggle('show-tr', on);
  }

  async function translateAll() {
    if (!lines.length) { alert('Ù…Ø§ ÙÙŠ Ù†Øµ Ù„Ù„ØªØ±Ø¬Ù…Ø© â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }

    const btn = document.getElementById('translateBtn');
    btn.disabled = true;
    btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ±Ø¬Ù…Ø©...';

    const alreadyDone = lines.filter(l => l.ar).length;
    if (alreadyDone === lines.length) {
      const toggle = document.getElementById('trToggle');
      toggle.checked = true;
      toggleTr();
      btn.disabled = false;
      btn.textContent = 'ğŸŒ ØªØ±Ø¬Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ';
      return;
    }

    const batchText = lines.map((l, i) => (i + 1) + '. ' + l.en).join('\n');

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          system: `You are a translator. The user will give you numbered English sentences from a video transcript. Translate each one to natural Arabic. Reply ONLY with a JSON array of strings, one Arabic translation per item, in the same order. No extra text, no markdown, no explanation. Just the raw JSON array. Example input: 1. Hello everyone\n2. Today we learn. Example output: ["Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ø¬Ù…ÙŠØ¹","Ø§Ù„ÙŠÙˆÙ… Ø³Ù†ØªØ¹Ù„Ù…"]`,
          messages: [{ role: 'user', content: batchText }]
        })
      });

      const data = await response.json();
      const raw = data.content.map(c => c.text || '').join('');
      const clean = raw.replace(/```json|```/g, '').trim();
      const translations = JSON.parse(clean);

      if (!Array.isArray(translations)) throw new Error('Bad format');

      translations.forEach((ar, i) => {
        if (lines[i]) lines[i].ar = ar || '';
      });

      lines.forEach((line, i) => {
        const arEl = document.querySelector('#tline-' + i + ' .t-ar');
        if (arEl && line.ar) arEl.textContent = line.ar;
      });

      const toggle = document.getElementById('trToggle');
      toggle.checked = true;
      toggleTr();

      btn.textContent = 'âœ“ ØªÙ…Øª Ø§Ù„ØªØ±Ø¬Ù…Ø©';
      setTimeout(() => { btn.textContent = 'ğŸŒ ØªØ±Ø¬Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'; btn.disabled = false; }, 2000);

    } catch (err) {
      console.error(err);
      btn.textContent = 'âŒ Ø®Ø·Ø£ â€” Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©';
      btn.disabled = false;
      setTimeout(() => { btn.textContent = 'ğŸŒ ØªØ±Ø¬Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ'; }, 2500);
    }
  }

  // â”€â”€ Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleLoop(idx, e) {
    e.stopPropagation();
    const btn = e.currentTarget;
    const badge = document.getElementById('loopBadge');

    if (loopIdx === idx) {
      loopIdx = null;
      badge.classList.remove('on');
      document.querySelectorAll('.rep-btn').forEach(b => b.classList.remove('on'));
      return;
    }

    loopIdx = idx;
    badge.classList.add('on');
    document.querySelectorAll('.rep-btn').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');

    if (player && player.seekTo) {
      player.seekTo(lines[idx].time, true);
      player.playVideo && player.playVideo();
    }
  }

  // â”€â”€ Seek â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function seekTo(idx) {
    if (!player || !player.seekTo) return;
    player.seekTo(lines[idx].time, true);
    player.playVideo && player.playVideo();
  }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderLines() {
    const body = document.getElementById('trBody');
    if (!lines.length) {
      body.innerHTML = `<div class="empty">
        <div class="empty-icon">âš ï¸</div>
        <p>Ù…Ø§ Ù‚Ø¯Ø±Ù†Ø§ Ù†Ù‚Ø±Ø£ Ø§Ù„ØªØ±Ø§Ù†Ø³ÙƒØ±ÙŠØ¨Øª â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø£Ùˆ Ø§Ù†Ø³Ø®Ù‡ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©</p>
      </div>`;
      return;
    }

    body.innerHTML = '';
    lines.forEach((line, i) => {
      const div = document.createElement('div');
      div.className = 't-line';
      div.id = 'tline-' + i;
      div.innerHTML = `
        <span class="t-time">${fmt(line.time)}</span>
        <div class="t-content">
          <div class="t-en">${esc(line.en)}</div>
          <div class="t-ar">${line.ar ? esc(line.ar) : ''}</div>
        </div>
        <button class="rep-btn" title="ÙƒØ±Ø± Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±" onclick="toggleLoop(${i}, event)">ğŸ”</button>
      `;
      div.addEventListener('click', (e) => {
        if (e.target.closest('.rep-btn')) return;
        seekTo(i);
      });
      body.appendChild(div);
    });
  }

  // â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmt(s) {
    const m = Math.floor(s / 60), sec = s % 60;
    return `${m}:${sec.toString().padStart(2,'0')}`;
  }

  function esc(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function clearAll() {
    document.getElementById('videoUrl').value  = '';
    document.getElementById('trInput').value   = '';
    document.getElementById('urlPill').style.display = 'none';
    document.getElementById('trPill').style.display  = 'none';
    document.getElementById('playerCard').classList.add('hidden');
    document.getElementById('trCard').classList.add('hidden');
    if (player && player.destroy) { player.destroy(); player = null; }
    if (tracker) clearInterval(tracker);
    lines = []; loopIdx = null;
    document.getElementById('loopBadge').classList.remove('on');
  }
</script>
</body>
</html>
